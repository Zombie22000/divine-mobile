---
title: "8:36:05 PM - November 8, 2025"
date: 2025-11-08T19:36:05.468Z
timestamp: 1762630565468
---

## Project Notes

**Authentication Flow Bug - Root Cause Analysis**

**The Problem:**
Users are seeing a "Create New Identity" / "Import Existing Identity" screen when they shouldn't. The app should automatically create an nsec for new users.

**What I Found:**

1. **AuthService DOES auto-create identities** (auth_service.dart:523-550):
   - When `_checkExistingAuth()` runs and finds no keys, it automatically calls `createNewIdentity()`
   - Log message: "No existing secure keys found, creating new identity automatically..."
   - This is the TikTok-style seamless onboarding that's intended

2. **The Race Condition:**
   - App starts → Router redirect runs
   - Router checks TOS acceptance → redirects to `/welcome` if not accepted
   - Welcome screen checks `authService.isAuthenticated`
   - BUT AuthService is still in `AuthState.checking` or `AuthState.authenticating` during auto-creation
   - `isAuthenticated` returns `false` during these states
   - Welcome screen shows create/import buttons instead of loading or continuing

3. **The Bug in welcome_screen.dart:30-31, 74-158:**
   - Only checks `isAuthenticated` boolean
   - Doesn't account for `AuthState.checking` or `AuthState.authenticating`
   - Shows wrong UI during auto-creation process

**The Fix:**
Welcome screen should check `authService.authState` and show:
- `AuthState.checking`: Loading spinner (checking for existing keys)
- `AuthState.authenticating`: Loading spinner (creating new identity)
- `AuthState.authenticated`: "Continue" button (TOS acceptance only)
- `AuthState.unauthenticated`: Should rarely happen, but if auto-creation fails, THEN show create/import buttons as fallback

**Files to modify:**
- `lib/screens/welcome_screen.dart` - Check authState instead of just isAuthenticated
