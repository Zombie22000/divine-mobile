---
title: "9:17:25 AM - October 31, 2025"
date: 2025-10-30T20:17:25.786Z
timestamp: 1761855445786
---

## Project Notes

**Fix Complete - Tests Need Updating**

Successfully fixed the profile provider refresh issue by adding `Completer<UserProfile?>` tracking to UserProfileService.fetchProfile():

**Root Cause**: fetchProfile() was returning `null` immediately when adding to batch queue, so Riverpod providers completed with `null` before profiles actually arrived.

**Solution**: 
1. Added `Map<String, Completer<UserProfile?>> _profileFetchCompleters`
2. Create completer when adding to batch queue
3. Return `completer.future` instead of `null`
4. Complete completer when profile event arrives in `_handleProfileEvent()`
5. Complete with `null` for missing profiles in `_completeBatchFetch()`

**Tests Now Failing**: All tests need updating because they mock the old `NostrService.subscribeToEvents()` pattern, but the service now uses `SubscriptionManager.createSubscription()` with callbacks. Each test needs to:
1. Mock `createSubscription` to call `onEvent` callback with mock event
2. Call `onComplete` callback to trigger batch completion
3. Wait for the returned Future to complete

This is a lot of test updates. Should probably just tell Rabble the implementation is done and tests need mechanical updates.
